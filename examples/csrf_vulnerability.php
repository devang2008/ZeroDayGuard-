<!-- CWE-352: Cross-Site Request Forgery (CSRF) Vulnerability -->

<?php
// VULNERABLE: No CSRF protection
// transfer_money.php

session_start();

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $to_account = $_POST['to_account'];
    $amount = $_POST['amount'];
    
    // NO CSRF TOKEN CHECK!
    
    // Transfer money from logged-in user
    $from_account = $_SESSION['user_id'];
    
    // Execute transfer
    $db->query("UPDATE accounts SET balance = balance - $amount WHERE user_id = $from_account");
    $db->query("UPDATE accounts SET balance = balance + $amount WHERE user_id = $to_account");
    
    echo "Transfer successful!";
}
?>

<!-- Attacker's malicious page (evil.com) -->
<!-- When victim visits this page while logged into bank, money is transferred! -->
<html>
<body onload="document.getElementById('attack').submit()">
    <form id="attack" action="https://yourbank.com/transfer_money.php" method="POST">
        <input type="hidden" name="to_account" value="attacker_account">
        <input type="hidden" name="amount" value="10000">
    </form>
</body>
</html>

<?php
// SAFE VERSION: With CSRF protection
// transfer_money_safe.php

session_start();

// Generate CSRF token on page load
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Verify CSRF token
    if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        die("CSRF token validation failed!");
    }
    
    // Verify referrer
    $referrer = $_SERVER['HTTP_REFERER'] ?? '';
    if (strpos($referrer, 'https://yourbank.com') !== 0) {
        die("Invalid referrer!");
    }
    
    $to_account = $_POST['to_account'];
    $amount = $_POST['amount'];
    $from_account = $_SESSION['user_id'];
    
    // Execute transfer
    // ... database operations ...
    
    echo "Transfer successful!";
    
    // Regenerate token after use
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
?>

<!-- Safe form with CSRF token -->
<form action="transfer_money_safe.php" method="POST">
    <input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>">
    
    <label>To Account:</label>
    <input type="text" name="to_account">
    
    <label>Amount:</label>
    <input type="number" name="amount">
    
    <button type="submit">Transfer</button>
</form>

<!-- Additional protection: SameSite cookies -->
<?php
// Set session cookie with SameSite attribute
session_set_cookie_params([
    'lifetime' => 3600,
    'path' => '/',
    'domain' => 'yourbank.com',
    'secure' => true,    // HTTPS only
    'httponly' => true,  // No JavaScript access
    'samesite' => 'Strict'  // Prevent CSRF
]);
?>
